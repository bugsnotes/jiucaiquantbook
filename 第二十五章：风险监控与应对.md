# ç¬¬äºŒåäº”ç« ï¼šé£é™©ç›‘æ§ä¸åº”å¯¹

ğŸ¯ **é€‚åˆäººç¾¤**ï¼šå®ç›˜è¿è¥è€… | â±ï¸ **é˜…è¯»æ—¶é—´**ï¼š1å°æ—¶

## æœ¬ç« å¯¼è¯»

é£é™©ç®¡ç†æ˜¯é‡åŒ–äº¤æ˜“çš„ç”Ÿå‘½çº¿ã€‚æœ¬ç« ä»‹ç»å®æ—¶é£é™©ç›‘æ§ç³»ç»Ÿçš„æ­å»ºå’Œé£é™©äº‹ä»¶çš„åº”å¯¹ç­–ç•¥ã€‚

**æœ¬ç« å†…å®¹**ï¼š
- ğŸ“Š 25.1 å®æ—¶é£é™©ç›‘æ§
- ğŸš¨ 25.2 é£é™©äº‹ä»¶åº”å¯¹
- ğŸ” 25.3 å¸¸è§é—®é¢˜è¯Šæ–­

---

## 25.1 å®æ—¶é£é™©ç›‘æ§

### â— 25.1.1 ç›‘æ§æŒ‡æ ‡ä½“ç³»

```python
class RiskMonitor:
    """å®æ—¶é£é™©ç›‘æ§ç³»ç»Ÿ"""

    def __init__(self, portfolio):
        self.portfolio = portfolio
        self.alerts = []

    def monitor_position_risk(self):
        """æŒä»“é£é™©ç›‘æ§"""
        positions = self.portfolio.get_positions()

        # 1. é›†ä¸­åº¦é£é™©
        total_value = sum(pos['value'] for pos in positions.values())

        for stock, pos in positions.items():
            concentration = pos['value'] / total_value

            if concentration > 0.10:  # å•ç¥¨è¶…è¿‡10%
                self.send_alert(
                    level='WARNING',
                    message=f"æŒä»“é›†ä¸­åº¦è¿‡é«˜: {stock} å æ¯”{concentration:.1%}"
                )

        # 2. è¡Œä¸šé›†ä¸­åº¦
        industry_exposure = self.calculate_industry_exposure(positions)
        for industry, exposure in industry_exposure.items():
            if exposure > 0.30:  # å•è¡Œä¸šè¶…è¿‡30%
                self.send_alert(
                    level='WARNING',
                    message=f"è¡Œä¸šé›†ä¸­åº¦è¿‡é«˜: {industry} å æ¯”{exposure:.1%}"
                )

    def monitor_drawdown(self):
        """å›æ’¤ç›‘æ§"""
        nav = self.portfolio.get_nav_series()
        current_nav = nav.iloc[-1]
        historical_high = nav.max()

        drawdown = (current_nav - historical_high) / historical_high

        if drawdown < -0.10:  # å›æ’¤è¶…è¿‡10%
            self.send_alert(
                level='WARNING',
                message=f"å½“å‰å›æ’¤{drawdown:.1%}, æ¥è¿‘é¢„è­¦çº¿"
            )

        if drawdown < -0.15:  # å›æ’¤è¶…è¿‡15%
            self.send_alert(
                level='CRITICAL',
                message=f"å½“å‰å›æ’¤{drawdown:.1%}, å»ºè®®å‡ä»“"
            )

        if drawdown < -0.20:  # å›æ’¤è¶…è¿‡20%
            self.send_alert(
                level='EMERGENCY',
                message=f"å½“å‰å›æ’¤{drawdown:.1%}, è§¦å‘å¼ºåˆ¶æ­¢æŸ"
            )
            self.emergency_stop()

    def monitor_trade_anomaly(self):
        """å¼‚å¸¸äº¤æ˜“ç›‘æ§"""
        today_trades = self.portfolio.get_today_trades()

        # 1. äº¤æ˜“æ¬¡æ•°å¼‚å¸¸
        if len(today_trades) > 100:  # å•æ—¥è¶…è¿‡100ç¬”
            self.send_alert(
                level='WARNING',
                message=f"ä»Šæ—¥äº¤æ˜“æ¬¡æ•°{len(today_trades)}ç¬”, å¯èƒ½å¼‚å¸¸"
            )

        # 2. å•ç¬”äº¤æ˜“é‡‘é¢å¼‚å¸¸
        for trade in today_trades:
            if trade['amount'] > self.portfolio.total_value * 0.20:
                self.send_alert(
                    level='CRITICAL',
                    message=f"å•ç¬”äº¤æ˜“é‡‘é¢{trade['amount']}å¼‚å¸¸, è¶…è¿‡æ€»èµ„äº§20%"
                )

    def send_alert(self, level, message):
        """å‘é€å‘Šè­¦"""
        alert = {
            'timestamp': datetime.now(),
            'level': level,
            'message': message
        }
        self.alerts.append(alert)

        # å‘é€é’‰é’‰é€šçŸ¥
        self.send_dingtalk(alert)

        # è®°å½•æ—¥å¿—
        logger.log(level, message)

    def send_dingtalk(self, alert):
        """å‘é€é’‰é’‰æ¶ˆæ¯"""
        import requests

        webhook_url = 'https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN'

        data = {
            'msgtype': 'text',
            'text': {
                'content': f"[{alert['level']}] {alert['message']}"
            }
        }

        requests.post(webhook_url, json=data)
```

---

## 25.2 é£é™©äº‹ä»¶åº”å¯¹

### â— 25.2.1 åº”æ€¥é¢„æ¡ˆ

```python
class EmergencyHandler:
    """åº”æ€¥å¤„ç†å™¨"""

    def handle_system_failure(self):
        """ç³»ç»Ÿæ•…éšœå¤„ç†"""
        print("æ£€æµ‹åˆ°ç³»ç»Ÿæ•…éšœ!")

        # 1. ç«‹å³åœæ­¢æ‰€æœ‰è‡ªåŠ¨äº¤æ˜“
        self.stop_auto_trading()

        # 2. ä¿å­˜å½“å‰çŠ¶æ€
        self.save_current_state()

        # 3. å‘é€ç´§æ€¥é€šçŸ¥
        self.send_emergency_notification(
            "ç³»ç»Ÿæ•…éšœ, å·²åœæ­¢è‡ªåŠ¨äº¤æ˜“, è¯·ç«‹å³æ£€æŸ¥!"
        )

        # 4. å¦‚æœæœ‰æŒä»“, æ‰‹åŠ¨å†³å®šæ˜¯å¦å¹³ä»“
        print("å½“å‰æŒä»“:")
        print(self.portfolio.get_positions())

    def handle_network_disconnection(self):
        """ç½‘ç»œä¸­æ–­å¤„ç†"""
        print("æ£€æµ‹åˆ°ç½‘ç»œä¸­æ–­!")

        # 1. å°è¯•é‡è¿
        retry_count = 0
        max_retries = 3

        while retry_count < max_retries:
            if self.test_connection():
                print("ç½‘ç»œæ¢å¤")
                return

            retry_count += 1
            time.sleep(30)

        # 2. é‡è¿å¤±è´¥, å¯åŠ¨åº”æ€¥æ¨¡å¼
        print("ç½‘ç»œæŒç»­ä¸­æ–­, å¯åŠ¨åº”æ€¥æ¨¡å¼")
        self.emergency_mode()

    def handle_strategy_malfunction(self):
        """ç­–ç•¥å¤±æ§å¤„ç†"""
        print("æ£€æµ‹åˆ°ç­–ç•¥å¯èƒ½å¤±æ§!")

        # åˆ¤æ–­æ ‡å‡†:
        # 1. è¿ç»­10ç¬”äºæŸäº¤æ˜“
        # 2. å•æ—¥äºæŸè¶…è¿‡3%
        # 3. äº¤æ˜“æ¬¡æ•°å¼‚å¸¸å¢å¤š

        recent_trades = self.portfolio.get_recent_trades(n=10)
        losing_trades = sum(1 for t in recent_trades if t['pnl'] < 0)

        if losing_trades >= 9:
            print("è¿ç»­äºæŸè¿‡å¤š, æš‚åœç­–ç•¥")
            self.pause_strategy()

            # å‘é€é€šçŸ¥
            self.send_emergency_notification(
                "ç­–ç•¥è¿ç»­äºæŸ, å·²æš‚åœ, è¯·æ£€æŸ¥ç­–ç•¥é€»è¾‘!"
            )

    def emergency_stop(self):
        """ç´§æ€¥åœæ­¢"""
        print("=" * 60)
        print("âš ï¸ æ‰§è¡Œç´§æ€¥åœæ­¢ âš ï¸")
        print("=" * 60)

        # 1. åœæ­¢æ‰€æœ‰ç­–ç•¥
        self.stop_all_strategies()

        # 2. æ’¤é”€æ‰€æœ‰æœªæˆäº¤è®¢å•
        self.cancel_all_orders()

        # 3. å¯é€‰: å¹³æ‰æ‰€æœ‰æŒä»“ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
        # self.close_all_positions()

        # 4. è®°å½•æ—¥å¿—
        logger.critical("æ‰§è¡Œç´§æ€¥åœæ­¢! æ‰€æœ‰ç­–ç•¥å·²åœæ­¢")

        # 5. å‘é€ç´§æ€¥é€šçŸ¥
        self.send_emergency_notification(
            "ğŸš¨ ç´§æ€¥åœæ­¢! æ‰€æœ‰ç­–ç•¥å·²åœæ­¢, è¯·ç«‹å³æ£€æŸ¥ç³»ç»Ÿ!"
        )
```

---

## 25.3 å¸¸è§é—®é¢˜è¯Šæ–­

### â— 25.3.1 é—®é¢˜è¯Šæ–­æµç¨‹

```python
class ProblemDiagnostics:
    """é—®é¢˜è¯Šæ–­å·¥å…·"""

    def diagnose_poor_performance(self):
        """è¯Šæ–­ç­–ç•¥è¡¨ç°å·®çš„åŸå› """
        print("\nå¼€å§‹è¯Šæ–­ç­–ç•¥è¡¨ç°...")

        checks = []

        # 1. æ£€æŸ¥å¸‚åœºç¯å¢ƒæ˜¯å¦å˜åŒ–
        market_regime = self.detect_market_regime_change()
        if market_regime['changed']:
            checks.append(
                f"âœ“ å¸‚åœºç¯å¢ƒå‘ç”Ÿå˜åŒ–: {market_regime['description']}"
            )

        # 2. æ£€æŸ¥æ‰§è¡Œåå·®
        execution_gap = self.calculate_execution_gap()
        if abs(execution_gap) > 0.05:
            checks.append(
                f"âœ“ æ‰§è¡Œåå·®è¿‡å¤§: {execution_gap:.2%}"
            )

        # 3. æ£€æŸ¥äº¤æ˜“æˆæœ¬
        actual_cost = self.calculate_actual_cost()
        backtest_cost = self.get_backtest_cost()
        if actual_cost > backtest_cost * 1.5:
            checks.append(
                f"âœ“ äº¤æ˜“æˆæœ¬é«˜äºé¢„æœŸ: {actual_cost:.4f} vs {backtest_cost:.4f}"
            )

        # 4. æ£€æŸ¥å› å­æœ‰æ•ˆæ€§
        ic = self.calculate_recent_ic()
        if abs(ic) < 0.02:
            checks.append(
                f"âœ“ å› å­æœ‰æ•ˆæ€§ä¸‹é™: IC={ic:.4f}"
            )

        # è¾“å‡ºè¯Šæ–­ç»“æœ
        if checks:
            print("\nå‘ç°ä»¥ä¸‹é—®é¢˜:")
            for check in checks:
                print(f"  {check}")
        else:
            print("\næœªå‘ç°æ˜æ˜¾é—®é¢˜, å¯èƒ½æ˜¯æ­£å¸¸æ³¢åŠ¨")

    def diagnose_execution_issues(self):
        """è¯Šæ–­æ‰§è¡Œé—®é¢˜"""
        issues = []

        # 1. æ£€æŸ¥æ»‘ç‚¹
        avg_slippage = self.calculate_average_slippage()
        if avg_slippage > 0.002:  # æ»‘ç‚¹è¶…è¿‡0.2%
            issues.append(f"æ»‘ç‚¹è¿‡å¤§: {avg_slippage:.3%}")

        # 2. æ£€æŸ¥æˆäº¤ç‡
        fill_rate = self.calculate_fill_rate()
        if fill_rate < 0.90:  # æˆäº¤ç‡ä½äº90%
            issues.append(f"æˆäº¤ç‡è¿‡ä½: {fill_rate:.1%}")

        # 3. æ£€æŸ¥å»¶è¿Ÿ
        avg_latency = self.calculate_average_latency()
        if avg_latency > 1000:  # å»¶è¿Ÿè¶…è¿‡1ç§’
            issues.append(f"å»¶è¿Ÿè¿‡é«˜: {avg_latency}ms")

        return issues
```

---

## æœ¬ç« å°ç»“

é£é™©ç›‘æ§ä¸åº”å¯¹çš„å…³é”®è¦ç‚¹ï¼š

### ğŸ“š æ ¸å¿ƒåŸåˆ™

1. **å®æ—¶ç›‘æ§**
   - æŒä»“é£é™©
   - å›æ’¤é¢„è­¦
   - å¼‚å¸¸äº¤æ˜“

2. **åº”æ€¥é¢„æ¡ˆ**
   - ç³»ç»Ÿæ•…éšœ
   - ç½‘ç»œä¸­æ–­
   - ç­–ç•¥å¤±æ§

3. **é—®é¢˜è¯Šæ–­**
   - ç³»ç»ŸåŒ–æ’æŸ¥
   - æ ¹å› åˆ†æ
   - åŠæ—¶ä¿®å¤

### âš ï¸ é‡è¦æé†’

- å§‹ç»ˆä¿æŒè­¦æƒ•
- ä¸è¦å¿½è§†ä»»ä½•å¼‚å¸¸ä¿¡å·
- åŠæ—¶æ­¢æŸ, ä¸è¦ä¾¥å¹¸

---

*æœ¬ç« å®Œ*
